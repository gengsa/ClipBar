# .git/hooks/pre-commit
# Pre-commit hook for Xcode/Swift project
# Does NOT specify a shell. Only requires addlicense in current PATH.

info()  { printf "\033[0;32m%s\033[0m\n" "$1"; }
error() { printf "\033[0;31m%s\033[0m\n" "$1"; }

COPYRIGHT_NAME="gengsa"
LICENSE_HEADER="apache"

# æ£€æŸ¥ addlicense æ˜¯å¦å¯ç”¨
if ! command -v addlicense >/dev/null 2>&1; then
    error "âŒ ERROR: addlicense command not found in your PATH."
    error "\tInstall: brew install addlicense"
    exit 1
fi

# è·å–æœ¬æ¬¡æäº¤çš„æ–‡ä»¶ï¼ˆéµå¾ª .gitignoreï¼‰
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

[ -z "$STAGED_FILES" ] && exit 0

# æ£€æŸ¥ license
info "ğŸ” Checking license headers..."

while IFS= read -r file; do
    addlicense -check -c "$COPYRIGHT_NAME" -l "$LICENSE_HEADER" "$file"
    # æ•è· addlicense é€€å‡ºç 
    if [ $? -ne 0 ]; then
        error "âŒ License check failed! Please add missing headers."
        # ä½¿ç”¨ -z å’Œ args -0 å®‰å…¨çš„å¤„ç†åŒ…å«ç©ºæ ¼å’Œæ¢è¡Œç¬¦çš„æ–‡ä»¶å
        error  "    git diff --cached --name-only --diff-filter=ACM -z | xargs -0 addlicense -c \"$COPYRIGHT_NAME\" -v -l \"$LICENSE_HEADER\""
        error "    Don't forget add changes file using git add."
        exit 1
    fi
done <<< "$STAGED_FILES"

info "âœ… License check passed!"
exit 0

